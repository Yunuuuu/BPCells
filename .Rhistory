knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
archr_read <- read_tsv("../results/archr_read.tsv")
archr_write <- read_tsv("../results/archr_write.tsv")
disk_io <- read_tsv("../results/disk_io.tsv")
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample, fill=compressed, group=compressed)) +
geom_point(position = "dodge2") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="")
getwd()
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(tidyverse))
archr_read <- read_tsv("../results/archr_read.tsv")
archr_write <- read_tsv("../results/archr_write.tsv")
disk_io <- read_tsv("../results/disk_io.tsv")
fragment_read <- bind_rows(
read_tsv("../results/fragment_read.tsv"),
read_tsv("../results/fragment_read_scan.tsv")
)
fragment_write <- read_tsv("../results/fragment_write.tsv")
stopifnot(all.equal(colnames(fragment_read), colnames(archr_read)))
stopifnot(all.equal(colnames(fragment_write), colnames(archr_write)))
disk_size <- tribble(
~sample, ~fragments, ~bytes_10x,
"10k_pbmc", 236393039, 2403785496,
"3k_pbmc", 44109954, 467587065
)
disk_read_speed <- 1.7e9
disk_write_speed <- 190e6
fragment_read <- bind_rows(fragment_read, archr_read) %>% inner_join(disk_size, by="sample")
fragment_write <- bind_rows(fragment_write, archr_write) %>% inner_join(disk_size, by="sample")
rm(archr_read, archr_write)
colors_format <- scale_color_manual(
values=`names<-`(
RColorBrewer::brewer.pal(5, "Set1"),
c("dir", "hdf5", "mem", "arrow", "10x"))
)
colors_compressed <- scale_color_manual(
values=c("FALSE"="#fb8072", "TRUE"="#80b1d3"),
labels=c("uncompressed", "compressed")
)
fill_compressed <- scale_fill_manual(
values=c("FALSE"="#fb8072", "TRUE"="#80b1d3"),
labels=c("uncompressed", "compressed")
)
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample, fill=compressed, group=compressed)) +
geom_point(position = "dodge2") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot() + fill_compressed
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample, fill=compressed, group=compressed)) +
stat_summary(fun="mean", geom="col") +
geom_point(position = "dodge2") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot() + fill_compressed
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample, fill=compressed,group=format)) +
stat_summary(fun="mean", geom="col") +
geom_point() +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot() + fill_compressed
fragment_write %>%
filter(!(compressed == FALSE & format == "10x")) %>%
ggplot(aes(format, elapsed/60, group=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange",
position=position_dodge2(width=0.5), color=colors_compressed["TRUE"]) +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment write time by format", y="minutes", color="") +
facet_wrap("sample", ncol=2, scales = "free_y") +
cowplot::theme_cowplot()
colors_compressed
fragment_write %>%
filter(!(compressed == FALSE & format == "10x")) %>%
ggplot(aes(format, elapsed/60, group=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange",
position=position_dodge2(width=0.5), fill="#80b1d3") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment write time by format", y="minutes", color="") +
facet_wrap("sample", ncol=2, scales = "free_y") +
cowplot::theme_cowplot()
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample,group=format)) +
stat_summary(fun="mean", geom="col", fill="#80b1d3") +
geom_point() +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot() + fill_compressed
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
ggplot(aes(format, bytes/fragments, shape=sample,group=format)) +
stat_summary(fun="mean", geom="col", fill="#80b1d3") +
geom_point() +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06)),
breaks = scales::breaks_width(4)) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot()
fragment_write %>% filter(format == "10x")
?dplyr::recode
fragment_write %>%
filter(replicate==1,
!(compressed == FALSE & format != "arrow"),
format %in% c("10x", "arrow", "mem")) %>%
mutate(format=recode(format, mem="mine")) %>%
ggplot(aes(format, bytes/fragments, shape=sample,group=format)) +
stat_summary(fun="mean", geom="col", fill="#80b1d3") +
geom_point() +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06)),
breaks = scales::breaks_width(4)) +
labs(title="Fragment storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot()
source('~/Downloads/bitpacking_notes/matrix_storage.R')
tribble(
~format,~bytes/entry,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
)
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
)
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
) %>%
ggplot(aes(x=format, y=`bytes/entry`)) +
geom_col()
8/1.33
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
) %>%
arrange(desc(`bytes/entry`)) %>%
mutate(
format = factor(format, format)
) %>%
ggplot(aes(x=format, y=`bytes/entry`)) +
geom_col()
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
) %>%
arrange(desc(`bytes/entry`)) %>%
mutate(
format = factor(format, format)
) %>%
ggplot(aes(x=format, y=`bytes/entry`)) +
geom_col(fill = "#80b1d3") +
labs(title="Matrix storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot()
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & compressed", (3.0+7.64)/8
) %>%
arrange(desc(`bytes/entry`)) %>%
mutate(
format = factor(format, format)
) %>%
ggplot(aes(x=format, y=`bytes/entry`)) +
geom_col(fill = "#80b1d3") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06)),
breaks = scales::breaks_width(4)) +
labs(title="Matrix storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot()
tribble(
~format,~`bytes/entry`,
"Sparse integer", 8,
"R sparse", 12,
"Compressed", (4.5+11.2)/8,
"Re-ordered & \ncompressed", (3.0+7.64)/8
) %>%
arrange(desc(`bytes/entry`)) %>%
mutate(
format = factor(format, format)
) %>%
ggplot(aes(x=format, y=`bytes/entry`)) +
geom_col(fill = "#80b1d3") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06)),
breaks = scales::breaks_width(4)) +
labs(title="Matrix storage size by format", y="bytes/fragment", fill="") +
cowplot::theme_cowplot()
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "scan_fragments", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange",
mapping=aes(group=str_c(compressed, "_", format))) +
stat_summary(fun="mean", geom="line", mapping=aes(linetype=compressed)) +
geom_line(data=disk_size, mapping=aes(fragments, 12*fragments/disk_read_speed, color="black"), color="black") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="basic scan (black line = speed of raw disk read)",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "scan_fragments", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange",
mapping=aes(group=str_c(compressed, "_", format))) +
stat_summary(fun="mean", geom="line", mapping=aes(linetype=compressed)) +
geom_line(data=disk_size, mapping=aes(fragments, 12*fragments/disk_read_speed, color="black"), color="black") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="basic scan (black line = speed of raw disk read)",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(format, elapsed, color=compressed, group=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange",
position=position_dodge2(width=0.5)) +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts", y="seconds", color="") +
facet_wrap("sample", ncol=2, scales = "free_y") +
cowplot::theme_cowplot() + colors_compressed
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="pointrange") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="point") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="median", fun.min="min", fun.max="max", geom="point") +
stat_summary(fun="median", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="median", fun.min="min", fun.max="max", geom="point") +
stat_summary(fun="median", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="point") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", fun.min="min", fun.max="max", geom="point") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
fragment_read %>%
filter(task == "nucleosome_counts", format != "10x", format != "arrow") %>%
ggplot(aes(fragments, elapsed, color=format, linetype=compressed)) +
stat_summary(fun="mean", geom="point") +
stat_summary(fun="mean", geom="line") +
scale_y_continuous(limits=c(0,NA), expand=expansion(mult=c(0, 0.06))) +
scale_x_continuous(limits=c(0, NA), expand=expansion(mult=c(0, 0.06))) +
labs(title="Fragment read time by format", subtitle="nucleosome counts",  y="seconds") +
cowplot::theme_cowplot() + colors_format
